# AI Memory Cache - Apache Tomcat

**Project**: Apache Tomcat 12.0  
**Last Updated**: 2025-01-03  
**Purpose**: Cross-session learning and pattern recognition for AI assistants

## Hotspots

### Frequently Modified Files
> Files with high change frequency - handle with care

| File | Frequency | Reason | Caution |
|------|-----------|--------|---------|
| `java/org/apache/catalina/connector/Request.java` | ⭐⭐⭐⭐⭐ | Core request handling, performance optimizations | Changes affect entire request processing pipeline |
| `java/org/apache/catalina/core/StandardContext.java` | ⭐⭐⭐⭐ | Web application context management | Critical for webapp lifecycle and deployment |
| `java/org/apache/tomcat/util/net/NioEndpoint.java` | ⭐⭐⭐⭐ | NIO connector improvements and bug fixes | Performance-critical I/O handling |
| `java/org/apache/jasper/JspC.java` | ⭐⭐⭐⭐ | JSP compilation tooling | Affects build-time JSP processing |
| `java/org/apache/coyote/http11/Http11Processor.java` | ⭐⭐⭐ | HTTP/1.1 protocol handling | Protocol compliance critical |

### Performance-Critical Areas

#### I/O Endpoints 
**Location**: `java/org/apache/tomcat/util/net/*Endpoint.java`  
**Description**: NIO, NIO2, APR connectors  
**Considerations**:
- Avoid synchronization in hot paths
- Minimize memory allocations
- Use direct ByteBuffers where possible

#### Coyote Adapter
**Location**: `java/org/apache/catalina/connector/CoyoteAdapter.java`  
**Description**: Bridge between Coyote and Catalina  
**Considerations**:
- Hot path for every request
- Avoid reflection
- Cache expensive lookups

#### Buffer Management
**Location**: `java/org/apache/tomcat/util/buf/*`  
**Description**: Buffer management utilities  
**Considerations**:
- Reuse buffers aggressively
- Avoid unnecessary copying
- Use direct memory access when safe

#### Session Management
**Location**: `java/org/apache/catalina/session/*`  
**Description**: Session lifecycle management  
**Considerations**:
- Minimize serialization overhead
- Efficient session storage patterns
- Quick session expiration checks

## Recurring Issues

### Common Bug Patterns

#### NullPointerException in Request Processing
**Typical Cause**: Async request handling edge cases  
**Solution**: Check `request.isAsyncStarted()` and ensure proper cleanup  
**Files to Check**: `AsyncContextImpl.java`, `CoyoteAdapter.java`

#### Memory Leaks on Webapp Reload
**Typical Cause**: ThreadLocal not cleared, static references held  
**Solution**: Use `WebappClassLoaderBase` leak detection  
**Prevention**: Clear ThreadLocals in `stopInternal()`

#### Character Encoding Issues
**Typical Cause**: Inconsistent charset handling across components  
**Solution**: Check `Request.setCharacterEncoding()` timing  
**Rule**: Set encoding before reading parameters

#### Session Replication Failures  
**Typical Cause**: Non-serializable session attributes  
**Solution**: Implement `Serializable`, check `DeltaManager` logs  
**Debug**: Enable tribes debugging for cluster communication

### Test Failure Patterns

#### WebSocket Tests
**Common Issue**: Timing-dependent failures in async operations  
**Solution**: Add proper synchronization, increase timeouts  
**Pattern**: Use `CountDownLatch` for coordination

#### Cluster Tests
**Common Issue**: Port conflicts in parallel test execution  
**Solution**: Use dynamic port allocation  
**Code**: `tomcat.setPort(0)` for random free port

#### SSL/TLS Tests
**Common Issue**: Certificate expiration  
**Solution**: Regenerate test certificates regularly  
**Location**: `test/org/apache/tomcat/util/net/SSLUtilTest.java`

## Team Preferences

### Coding Standards
- **Indentation**: 4 spaces, no tabs
- **Line Length**: 80-100 characters preferred  
- **Naming**: Java standard (camelCase methods, UPPER_CASE constants)
- **Comments**: Javadoc for public API, inline comments sparingly
- **Imports**: No wildcard imports, organize by package

### Commit Message Format
**Pattern**: `Component: Brief description`

**Examples**:
- `Fix BZ 12345 - Correct NPE in Request processing`
- `Code cleanup. No functional change.`
- `Update dependency to version x.y.z`

**Cherry-picking**: Backport fixes to stable branches when applicable

### Code Review Focus Areas
1. **Security implications** - Always consider security impact
2. **Backward compatibility** - Don't break existing APIs
3. **Performance impact** - Measure performance-critical changes
4. **Specification compliance** - Follow Jakarta EE specs
5. **Thread safety** - Consider concurrent access patterns

## No-Go Areas

### Generated Code - DO NOT MODIFY

#### JavaCC Generated Files
**Location**: `java/org/apache/el/parser/*`  
**Reason**: Generated by JavaCC parser  
**Source**: `java/org/apache/el/parser/ELParser.jj`  
**Rule**: Modify .jj source files instead

#### JSON Parser
**Location**: `java/org/apache/tomcat/util/json/*`  
**Reason**: Generated parser code  
**Rule**: Regenerate from grammar files

### Legacy Compatibility Areas

#### Deprecated HA Implementation
**Location**: `java/org/apache/catalina/ha/*` (legacy parts)  
**Reason**: Legacy HA implementation  
**Alternative**: Use `java/org/apache/catalina/tribes/` instead

#### Server Side Includes
**Location**: `java/org/apache/catalina/ssi/*`  
**Reason**: Security-sensitive, rarely used  
**Caution**: Consult security team before modifications

### External Dependencies

#### Repackaged Commons DBCP
**Location**: `java/org/apache/tomcat/dbcp/dbcp2/*`  
**Reason**: Repackaged Apache Commons DBCP  
**Update Process**: Update via build properties, not direct edits

#### Repackaged Commons Pool  
**Location**: `java/org/apache/tomcat/dbcp/pool2/*`  
**Reason**: Repackaged Apache Commons Pool  
**Update Process**: Update via build properties, not direct edits

## Optimization Opportunities

### Known Bottlenecks

#### String Concatenation in Logging
**Problem**: Expensive string building in hot paths  
**Solution**: Use parameterized logging (`log.debug("Value: {}", value)`)  
**Impact**: Reduced allocation in performance-critical code

#### Reflection in Annotation Scanning
**Problem**: Expensive reflection during startup  
**Solution**: Cache reflection results, use bytecode analysis  
**Impact**: Faster webapp deployment and startup

#### XML Parsing in Configuration
**Problem**: DOM parsing uses excessive memory  
**Solution**: Use StAX streaming parser where possible  
**Impact**: Lower memory footprint during startup

### Refactoring Candidates

#### Authentication/Authorization Hierarchy
**Issue**: Complex inheritance hierarchy difficult to extend  
**Suggestion**: Consider composition over inheritance patterns  
**Files**: `AuthenticatorBase.java`, realm implementations

#### JMX Registration Logic
**Issue**: Scattered MBean registration throughout codebase  
**Suggestion**: Centralize MBean management  
**Benefit**: Easier maintenance and consistency

## Debugging Hints

### Useful Breakpoints
- `StandardWrapperValve.invoke()` line ~200 - Servlet execution entry
- `CoyoteAdapter.service()` line ~300 - Request processing start  
- `StandardContext.startInternal()` line ~5000 - Webapp startup
- `NioEndpoint$Poller.run()` - I/O event processing loop

### Logging Configuration Tips

#### Per-Component Logging
```properties
# Request processing
org.apache.catalina.core.ContainerBase.[Catalina].[localhost].level = FINE

# Cluster communication  
org.apache.catalina.tribes.MESSAGES.level = FINE

# JSP compilation issues
org.apache.jasper.compiler.Compiler.level = FINE

# Connection handling
org.apache.tomcat.util.net.NioEndpoint.level = FINE
```

### Useful System Properties

#### Debugging Properties
- `org.apache.catalina.startup.EXIT_ON_INIT_FAILURE=true` - Stop on startup errors
- `org.apache.catalina.connector.RECYCLE_FACADES=false` - Disable request/response recycling for debugging
- `catalina.base` - Tomcat instance base directory
- `catalina.home` - Tomcat installation directory

#### Performance Properties
- `org.apache.catalina.connector.CoyoteAdapter.ALLOW_BACKSLASH=false`
- `org.apache.tomcat.util.buf.StringCache.cache.size=5000`

## Common Debugging Scenarios

### Memory Leak Investigation
1. Enable leak detection: Set `logEffectiveWebXml="true"` in Context
2. Check ThreadLocal cleanup in `stopInternal()` methods
3. Examine static references in webapp classes
4. Review `WebappClassLoaderBase.clearReferencesXxx()` methods

### Performance Issues
1. Enable access log valve for request timing
2. Use JProfiler/YourKit on specific scenarios
3. Check GC logs for memory pressure
4. Profile I/O operations in NioEndpoint

### Clustering Problems
1. Enable tribes debugging: `org.apache.catalina.tribes.MESSAGES=FINE`
2. Check network connectivity between cluster nodes
3. Verify session serialization of all attributes
4. Monitor cluster membership changes

## Update Protocol

### When to Update This Cache
1. **New recurring issues** discovered during development
2. **Performance bottlenecks** identified and resolved
3. **Team decisions** on coding standards or patterns
4. **Environmental quirks** specific to build/deployment

### Self-Improvement Checklist
Before completing any task:
- [ ] Document any repeated issues encountered
- [ ] Note useful debugging techniques discovered  
- [ ] Record environment-specific solutions
- [ ] Update patterns that differ from documentation